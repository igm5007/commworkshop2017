<!DOCTYPE html>
<html>
<head>
	<title>live data and music</title>
	<link rel="stylesheet" type="text/css" href="css/reset.css">

</head>
<body>


	<button onclick="drawBars()">Histogram</button>

	<button onclick="drawVenues()">Venues!</button>

	<button onclick="drawMap()">Draw Map</button>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
	<script type="text/javascript" src="spotify-web-api.js"></script>
	<script type="text/javascript">
		
	//sets working size of the animation
	var width = 800;
	var height = 800;

	//store the api key
	var apikey = "xhPCSBfc3AI94hs3"

	var spotifyApi = new SpotifyWebApi();
	//spotifyApi.setAccessToken('<here_your_access_token>');

	//scale for longitude to pixels
	//var x = d3.scaleLinear().domain([-180,180]).range([width / 8,width]);

	//scale for latitude to pixels
	//var y = d3.scaleLinear().domain([-90,90]).range([height, height / 8]);
	
	//set up the projection
	var projection = d3.geoEquirectangular()
	.scale(80000)
	.translate([width / 2, height / 2])
	.rotate([87.6,-41.8,0]);

	//set up path generator
	var path = d3.geoPath().projection(projection);

	//create svg container
	var svg = d3.select("body")
	.append("svg")
	.attr("width", width)
	.attr("height", height)
	.style("background-color","#ccc");

	//call data for chicago
	d3.json("chicago.json",function(error,geojson){
		svg.append("path")
		.attr("d", path(geojson))
		.classed("chicago",true);
	});

	var dates = [];
	var shows = [];
	var artistIDs = [];

	var today = new Date();
	var dd = today.getDate();
	var mm = today.getMonth()+1;
	var yyyy = today.getFullYear();

	if(dd < 10){
		dd = '0' + dd;
	}

	if(mm < 10){
		mm = '0' + mm;
	}

	today = yyyy + mm + dd;

	// The following codeblock builds the arrays that will be used for the visualization. 
	// the songkick API is called using d3
	d3.json("http://api.songkick.com/api/3.0/metro_areas/9426/calendar.json?apikey=xhPCSBfc3AI94hs3", function(error, data) {

		// d3 creates an array by iterating through each of the items nested within the songkick API return
		d3.selectAll(".blob").data(data.resultsPage.results.event).enter().each(
			function(d,i){

				//stores the start date, time, artist name, longitude, and latitutde of the event into a single dimension array
				var event = [parseInt(d.start.date.replace(/-/g,""),10), d.start.time, d.performance[0].displayName, d.venue.lng, d.venue.lat];

				//creates an array to hold each individual event array
				dates.push(event);

				/*if(event[0] == today){
					dates.push(event);
				}*/

				//calls the spotify API and searches for the most popular artist URI from the dates array
				spotifyApi.searchArtists(dates[i][2])
				.then(function(data2) {

					//grabs the artist URI and finds the artist info in spotify
					spotifyApi.getArtist(data2.artists.items[0].id)
					.then(function(data3) {
						//console.log('Artist information', data3);

						//combines the artist URI, genre array, and event array, into individaul arrays 
						var artistInfo = [data3.id, data3.genres, event];

						//combines the individual artistInfo arrays into a larger array
						shows.push(artistInfo);


					}, function(err) {
						console.error(err);
					});

				}, function(err) {
				//console.error(err);

				
			});


			})
		
		//
		//
		//
		//
		//
		//
		//console.log(dates.length);
		//console.log(shows);

		/*for(i=0; i<dates.length; i++){

			spotifyApi.searchArtists(dates[i][2])
			.then(function(data2) {

					artistIDs.push(data2.artists.items[0].id);
					spotifyApi.getArtist(data2.artists.items[0].id)
					.then(function(data3) {
						//console.log('Artist information', data3);

						var artistInfo = [data3.id, data3.genres];
						console.log(artistInfo);
						//dates[i].push(artistInfo);

					}, function(err) {
						console.error(err);
					});

			}, function(err) {
				//console.error(err);
			});

		};*/

		console.log(shows);


	});

//	console.log(today);


	//draws the initial layout
	d3.json("data3.json", function(error, data) {
		//if data is missing or broken, ignore that and move forward
		if (error) throw error;

		//sets the width of each bar based on the number of bars being created
		var barWidth = width/data.length;

		//creates each bar of the histogram 
		svg.selectAll(".bars")
			//calls zee data
			.data(data)
			.enter()
			//creates the bars
			.append("rect")
			//positions the bars along the x-axis, 1 is subtracted from the day number to ensure it starts at the zero point. 
			.attr("x", function(d){return (d.day-1)*barWidth})
			//positions the bars along y-axis
			.attr("y", function(d){return height-d.genretotal})
			//applies the previously defined barWidth to the rect svg
			.attr("width", barWidth)
			//applies the genretotal as the height of the svgs
			.attr("height", function(d){return d.genretotal})
			//sets the color
			.attr("fill", "steelblue")
			//gives the rectangles the class "bar"
			.classed("bars", true)
			;

	});

	//histogram bar animations and update
	function drawBars(){
		d3.json("data3.json", function(error,data){
			//save selection of bars in a variable for easier use
			var bars = svg.selectAll(".bars")
			.data(data);

			//update bars when data changes
			bars
			.transition()
			.duration(500)
			.attr("height", function(d){return d.genretotal*1.5})
			.attr("y", function(d){return height-d.genretotal*1.5})
			.transition()
			.duration(500)
			.attr("height", function(d){return d.genretotal})
			.attr("y", function(d){return height-d.genretotal})
			;
		});
	}


	//needs to be updated to call the shows array, not a json file
	function drawMap(){


			//svg.selectAll(".dot").remove();

			svg.selectAll(".dot")
			.data(shows)
			.enter()
			.append("circle")
			.attr("transform", function(d){ return "translate (" + projection([d[2][3],d[2][4]]) + ")";
			})
			.attr("r", 5)
			.attr("fill", "#fff")
			.attr("stroke","#fff")
			.attr("stroke-width",2)
			.classed("dot",true);

			/*svg.selectAll(".venues")
			.data(shows)
			.enter()
			.append(shows[1])
			.text(function(d){return d.genre})
			.attr("transform", function(d){return "translate (" + projection([shows[2][3],shows[2][4]]) + ")";
		})
			.classed("venues",true);
*/

	}

	drawMap();



	//runs the drawBars function every 5 seconds
	/*var interval = setInterval(
		function(){
			drawBars();
			drawVenues();
		}, 5000
		);
		*/


		
	</script>

</body>
</html>