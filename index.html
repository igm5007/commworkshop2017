<!DOCTYPE html>
<html>
<head>
	<title>live data and music</title>
	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<style>

    	#title {

    	}
    
	  	.pulse {
	  		animation: pulse 2s ease infinite
	  	}

	  	@keyframes pulse {
	  		0% {
	  			transform: scale(0.5);
	  			transform-origin: center center;
	  			opacity: 0.8
	  		}
	  		100% {
	  			transform: scale(1.5);
	  			transform-origin: center center;
	  			opacity: 0
	  		}
	  	}
    
    
  </style>
</head>
<body>

	<button onclick="drawMap()">Draw Map</button>
	<button onclick="buildArray()">Build Array</button>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
	<script type="text/javascript" src="spotify-web-api.js"></script>

	<script type="text/javascript">
		
	//sets working size of the animation
	var width = 1200;
	var height = 800;

	//store the api key
	var apikey = "xhPCSBfc3AI94hs3"



	//var clientID = 'b1afc2d4e8414a51a1d2301312921fb8';
	//var clientSecret = 'b8c9484c6dd54ea38439921cd2e535e7';
	var spotifyApi = new SpotifyWebApi();

	spotifyApi.setAccessToken("");

	
	//scale for longitude to pixels
	//var x = d3.scaleLinear().domain([-180,180]).range([width / 8,width]);

	//scale for latitude to pixels
	//var y = d3.scaleLinear().domain([-90,90]).range([height, height / 8]);
	
	//set up the projection
	var projection = d3.geoEquirectangular()
	.scale(100000)
	.translate([width / 1.5, height / 1.75])
	.rotate([87.6,-41.8,0]);

	//set up path generator
	var path = d3.geoPath().projection(projection);

	//create svg container
	var svg = d3.select("body")
	.append("svg")
	.attr("width", width)
	.attr("height", height)
	.style("background-color","#ccc");

	//call data for chicago
	d3.json("chicago.json",function(error,geojson){
		svg.append("path")
		.attr("d", path(geojson))
		.classed("chicago",true);

	});

	var dates = [];
	var shows = [];
	var artistIDs = [];

	buildArray();

	var today = new Date();
	var dd = today.getDate();
	var mm = today.getMonth()+1;
	var yyyy = today.getFullYear();
	var hour = today.getHours().toString();
	var min = today.getMinutes().toString();
	var sec = today.getSeconds();
	var currentTime = 0;

	if(dd < 10){
		dd = '0' + dd;
	}

	if(mm < 10){
		mm = '0' + mm;
	}

	if(hour < 10){
		hour = '0' + hour;
	}

	if(min < 10){
		min = '0' + min;
	}

	console.log(hour);
	console.log(min);
	today = yyyy + mm + dd;
	currentTime =  1000//parseInt(hour + min, 10);
	console.log(currentTime);

	function buildArray(){



	// The following codeblock builds the arrays that will be used for the visualization. 
	// the songkick API is called using d3

	
	d3.json("http://api.songkick.com/api/3.0/metro_areas/9426/calendar.json?apikey=xhPCSBfc3AI94hs3", function(error, data) {


		// d3 creates an array by iterating through each of the items nested within the songkick API return
		d3.selectAll(".blob").data(data.resultsPage.results.event).enter().each(
			function(d,i){

				var startTime = d.start.time;

				if(startTime != null){
					startTime = parseInt(startTime.replace(/:/,""),10);
				}
				else {
					startTime = 2000;
				}

				//stores the start date, time, artist name, longitude, and latitutde of the event into a single dimension array
				var event = [parseInt(d.start.date.replace(/-/g,""),10), startTime, d.performance[0].displayName, d.venue.lng, d.venue.lat];

				//creates an array to hold each individual event array
				var endTime = startTime + 200;

				if(event[0] == today){
					if(currentTime < endTime){
						
					
						//calls the spotify API and searches for the most popular artist URI from the dates array
						spotifyApi.searchArtists(event[2])
						.then(function(data2) {
						
							//grabs the artist URI and finds the artist info in spotify
							spotifyApi.getArtist(data2.artists.items[0].id)
							.then(function(data3) {
								//console.log('Artist information', data3);
								var artistInfo = [data3.id, data3.genres, event];

								//find the top tracks for the artist, 0 index being the most popular, 10 index being the tenth most popular
								spotifyApi.getArtistTopTracks(data3.id, 'US')
								.then(function(data4) {
									var track = [data4.tracks[0]];

									//gets audio analysis for each track
									spotifyApi.getAudioFeaturesForTrack(data4.tracks[0].id)
									.then(function(data5) {
										var trackInfo = [track, data5, artistInfo];
										shows.push(trackInfo);
										

										
											drawMap();
											liveShow();

										

									}, function(err) {
										done(err);
									});


								}, function(err) {
									console.log('Something went wrong!', err);
								});

							}, function(err) {
								console.error(err);
							});

						}, function(err) {
						//console.error(err);

						
						});
					}
				}
			})
		console.log(shows);


	});
}
	
	function liveShow(shows){
		var dots2 = svg.selectAll(".dots2").data(shows);

		if(shows[2][2][1] >= currentTime){
			dots2
			.enter()
			.append("circle")
			.classed("dots2", true)
			.attr("transform", function(d){ return "translate (" + projection([d[2][2][3],d[2][2][4]]) + ")";
			})
			.attr("r", 2.5)
			.attr("fill", "red")
			.transition()
			.duration(2000)
			.attr("r", 25)
			.style("fill-opacity", 0)
			.each("end", function(){liveShow();})
			;
		}
	}

	//needs to be updated to call the shows array, not a json file
	function drawMap(){
		
			var dots = svg.selectAll(".dots").data(shows);
			//svg.selectAll(".dot").remove();


			dots
			.enter()
			.append("circle")
			.attr("transform", function(d){ return "translate (" + projection([d[2][2][3],d[2][2][4]]) + ")";
			})
			.attr("fill", "#fff")
			.attr("stroke","#fff")
			.attr("stroke-width",2)
			.attr("r", 2.5)
			.classed("dots", true);



			dots
			.exit()
			.transition()
			.duration(3000)
			.ease(d3.easeBounceOut)
			.attr("cy", height)
			.style("fill-opacity", 0)
			.remove()
		
	}




	//runs the drawBars function every 5 seconds
	/*var interval = setInterval(
		function(){
			drawBars();
			drawVenues();
		}, 5000
		);
		*/


		
	</script>

</body>
</html>